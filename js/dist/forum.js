(()=>{var t={n:o=>{var a=o&&o.__esModule?()=>o.default:()=>o;return t.d(a,{a}),a},d:(o,a)=>{for(var r in a)t.o(a,r)&&!t.o(o,r)&&Object.defineProperty(o,r,{enumerable:!0,get:a[r]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},o={};(()=>{"use strict";t.r(o),t.d(o,{extend:()=>Y});const a=flarum.core.compat["common/app"];t.n(a)().initializers.add("ianm/twofactor",(function(){}));const r=flarum.core.compat["forum/app"];var e=t.n(r);const n=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/UserSecurityPage"];var s=t.n(i);function c(t,o){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,o){return t.__proto__=o,t},c(t,o)}function u(t,o){t.prototype=Object.create(o.prototype),t.prototype.constructor=t,c(t,o)}const l=flarum.core.compat["common/Component"];var d=t.n(l);const f=flarum.core.compat["common/components/Button"];var h=t.n(f);const p=flarum.core.compat["common/utils/ItemList"];var v=t.n(p);const w=flarum.core.compat["common/helpers/listItems"];var y=t.n(w);const b=flarum.core.compat["common/helpers/icon"];var _=t.n(b),g=function(t){function o(){return t.apply(this,arguments)||this}return u(o,t),o.prototype.view=function(){var t=this.attrs,o=t.icon,a=t.title,r=t.value,e=t.action,n=t.helpText;return m("li",{className:"TwoFactorGrid-item"},m("span",{className:"TwoFactorGrid-icon"},_()(o)),m("div",{className:"TwoFactorGrid-content"},m("span",{className:"TwoFactorGrid-title"},a),m("span",{className:"TwoFactorGrid-value"},r),n&&m("span",{className:"helpText TwoFactorGrid-helpText"},n)),e&&m("span",{className:"TwoFactorGrid-actions"},e))},o}(d());const k=flarum.core.compat["common/components/Tooltip"];var T=t.n(k);const F=flarum.core.compat["common/components/Modal"];var N=t.n(F);const C=flarum.core.compat["common/utils/Stream"];var D=t.n(C);const q=flarum.core.compat["common/components/LoadingIndicator"];var B=t.n(q),E=function(t){function o(){for(var o,a=arguments.length,r=new Array(a),e=0;e<a;e++)r[e]=arguments[e];return(o=t.call.apply(t,[this].concat(r))||this).value="",o}u(o,t);var a=o.prototype;return a.oninit=function(o){t.prototype.oninit.call(this,o),this.value=o.attrs.initial||""},a.oninput=function(t){var o=t.target;this.value=o.value,6===this.value.length&&this.attrs.onComplete(this.value)},a.onkeydown=function(t){"Enter"===t.key&&(t.preventDefault(),this.attrs.onComplete(this.value))},a.view=function(){var t=this;return m("input",{type:"text",className:"FormControl",value:this.value,placeholder:this.attrs.placeholder||"Enter 6-digit code",oninput:function(o){return t.oninput(o)},onkeydown:function(o){return t.onkeydown(o)},inputmode:"numeric",pattern:"[0-9]*",autocomplete:"one-time-code"})},o}(d()),x=function(t){function o(){for(var o,a=arguments.length,r=new Array(a),e=0;e<a;e++)r[e]=arguments[e];return(o=t.call.apply(t,[this].concat(r))||this).user=void 0,o.status="loading",o.qrCodeUrl=null,o.backupCodes=[],o.token=void 0,o.code=null,o.activeTab="qrcode",o.loading=!1,o}u(o,t);var a=o.prototype;return a.oninit=function(a){t.prototype.oninit.call(this,a),this.user=this.attrs.user,this.token=D()(""),this.attrs.forced&&(o.isDismissibleViaCloseButton=!1,o.isDismissibleViaEscKey=!1,o.isDismissibleViaBackdropClick=!1)},a.className=function(){return"TwoFactorEnableModal Modal--small"},a.title=function(){return e().translator.trans("ianm-twofactor.forum.security.two_factor_heading")},a.oncreate=function(o){var a=this;t.prototype.oncreate.call(this,o);var r=this.user.id();e().request({method:"GET",url:e().forum.attribute("apiUrl")+"/users/"+r+"/twofactor/qrcode"}).then((function(t){a.qrCodeUrl=t.svg,a.code=t.code,a.status="displayQR",m.redraw()}))},a.onupdate=function(){var t=document.querySelector(".TwoFactorEnableModal [name=token]");t&&document.activeElement!==t&&t.focus()},a.content=function(){var t=this;return m("div",{className:"Modal-body"},"loading"===this.status&&m("div",{className:"loading"},m(B(),null),m("p",null,e().translator.trans("ianm-twofactor.forum.security.loading_qr"))),"displayQR"===this.status&&m("div",null,this.attrs.forced&&m("div",null,m("p",null,e().translator.trans("ianm-twofactor.forum.user_2fa.alert_message"))),m("div",{className:"tabs"},m(h(),{className:"TwoFactorModal-tab "+("qrcode"===this.activeTab?"active":""),onclick:function(){t.activeTab="qrcode",m.redraw()}},e().translator.trans("ianm-twofactor.forum.security.qr_tab")),m(h(),{className:"TwoFactorModal-tab "+("manual"===this.activeTab?"active":""),onclick:function(){t.activeTab="manual",m.redraw()}},e().translator.trans("ianm-twofactor.forum.security.manual_tab"))),"qrcode"===this.activeTab&&m("div",{className:"qrSection"},m("img",{className:"qrImage",src:this.qrCodeUrl,alt:e().translator.trans("ianm-twofactor.forum.security.qr_code_alt")}),m("p",{className:"helpText"},e().translator.trans("ianm-twofactor.forum.security.scan_qr_instruction"))),"manual"===this.activeTab&&m("div",{className:"manualEntrySection"},m("code",{className:"manualEntryCode"},this.code),m("p",{className:"helpText"},e().translator.trans("ianm-twofactor.forum.security.manual_entry_instruction"))),m("div",{className:"Form"},m("form",{onsubmit:this.onSubmit.bind(this)},m("div",{className:"Form-group"},m(E,{placeholder:e().translator.trans("ianm-twofactor.forum.security.enter_token"),initial:this.token(),onComplete:function(o){t.token(o),t.verifyToken()}})),m("div",{className:"Form-group"},m(h(),{type:"submit",className:"Button Button--primary",onclick:this.verifyToken.bind(this),loading:this.loading},e().translator.trans("ianm-twofactor.forum.security.verify_button")))))),"displayBackupCodes"===this.status&&m("div",null,m("p",null,e().translator.trans("ianm-twofactor.forum.security.backup_codes")),m("ul",null,this.backupCodes.map((function(t){return m("li",null,m("code",null,t))}))),m("p",null,e().translator.trans("ianm-twofactor.forum.security.backup_codes_instruction")),m(h(),{className:"Button Button--primary",onclick:function(){t.status="final",m.redraw()}},e().translator.trans("ianm-twofactor.forum.security.saved_backup_codes_button"))),"final"===this.status&&m("div",null,m("p",null,e().translator.trans("ianm-twofactor.forum.security.two_factor_enabled_confirmation")),m(h(),{className:"Button Button--primary",onclick:this.finish.bind(this)},e().translator.trans("ianm-twofactor.forum.security.ok_button"))))},a.verifyToken=function(){var t=this;this.loading=!0,e().request({method:"POST",url:e().forum.attribute("apiUrl")+"/users/twofactor/verify",body:{token:this.token()}}).then((function(o){var a=o.backupCodes;t.backupCodes=a,t.status="displayBackupCodes",m.redraw()})).catch((function(t){e().alerts.show({type:"error"},e().translator.trans("ianm-twofactor.forum.security.verification_failed"))})).finally((function(){t.loading=!1}))},a.finish=function(){var t,o;null==(t=(o=this.attrs).onEnabled)||t.call(o),this.hide()},a.onSubmit=function(t){t.preventDefault(),this.verifyToken()},o}(N());x.isDismissibleViaCloseButton=!0,x.isDismissibleViaEscKey=!0,x.isDismissibleViaBackdropClick=!0;const M=flarum.core.compat["common/helpers/username"];var S=t.n(M),R=function(t){function o(){return t.apply(this,arguments)||this}u(o,t);var a=o.prototype;return a.oninit=function(o){t.prototype.oninit.call(this,o),this.loading=!1},a.className=function(){return"TwoFactorDisableConfirmModal Modal--small"},a.title=function(){return e().translator.trans("ianm-twofactor.forum.security.confirm_disable_2fa_title")},a.content=function(){var t,o=(null==(t=e().session.user)?void 0:t.id())===this.attrs.user.id(),a=this.attrs.user;return m("div",{className:"Modal-body"},m("p",null,e().translator.trans(o?"ianm-twofactor.forum.security.confirm_disable_2fa_text":"ianm-twofactor.forum.security.confirm_disable_2fa_text_other_user",{username:S()(a)})),m("div",{className:"Form-group"},m(h(),{className:"Button Button--danger",onclick:this.disable.bind(this),loading:this.loading},e().translator.trans("ianm-twofactor.forum.security.disable_2fa_button")),m(h(),{className:"Button Button--cancel",onclick:this.hide.bind(this)},e().translator.trans("ianm-twofactor.forum.security.cancel_button"))))},a.disable=function(){var t=this;this.loading=!0;var o=this.attrs.user.id();e().request({method:"DELETE",url:e().forum.attribute("apiUrl")+"/users/"+o+"/twofactor/disable"}).then((function(){t.loading=!1,t.attrs.onDisabled(),t.hide()})).catch((function(t){}))},o}(N()),A=function(t){function o(){for(var o,a=arguments.length,r=new Array(a),e=0;e<a;e++)r[e]=arguments[e];return(o=t.call.apply(t,[this].concat(r))||this).user=void 0,o.status="verifyCurrentDevice",o.qrCodeUrl=null,o.backupCodes=[],o.currentToken=void 0,o.newToken=void 0,o.code=null,o.activeTab="qrcode",o.loading=!1,o}u(o,t);var a=o.prototype;return a.oninit=function(o){t.prototype.oninit.call(this,o),this.user=this.attrs.user,this.currentToken=D()(""),this.newToken=D()("")},a.className=function(){return"TwoFactorChangeDeviceModal Modal--small"},a.title=function(){return e().translator.trans("ianm-twofactor.forum.security.change_device_heading")},a.onupdate=function(){if("verifyCurrentDevice"===this.status){var t=document.querySelector(".TwoFactorChangeDeviceModal [name=currentToken]");t&&document.activeElement!==t&&t.focus()}else if("displayQR"===this.status){var o=document.querySelector(".TwoFactorChangeDeviceModal [name=newToken]");o&&document.activeElement!==o&&o.focus()}},a.content=function(){return m("div",{className:"Modal-body"},"verifyCurrentDevice"===this.status&&this.renderVerifyCurrentDevice(),"loadingQR"===this.status&&this.renderLoadingQR(),"displayQR"===this.status&&this.renderDisplayQR(),"displayBackupCodes"===this.status&&this.renderBackupCodes(),"final"===this.status&&this.renderFinal())},a.renderVerifyCurrentDevice=function(){var t=this;return m("div",null,m("p",null,e().translator.trans("ianm-twofactor.forum.security.verify_current_device_message")),m("div",{className:"Form"},m("form",{onsubmit:this.onVerifyCurrentDeviceSubmit.bind(this)},m("div",{className:"Form-group"},m(E,{placeholder:e().translator.trans("ianm-twofactor.forum.security.enter_current_token"),initial:this.currentToken(),onComplete:function(o){t.currentToken(o),t.verifyCurrentDevice()}})),m("div",{className:"Form-group"},m(h(),{type:"submit",className:"Button Button--primary",loading:this.loading},e().translator.trans("ianm-twofactor.forum.security.verify_button"))))))},a.renderLoadingQR=function(){return m("div",{className:"loading"},m(B(),null),m("p",null,e().translator.trans("ianm-twofactor.forum.security.loading_qr")))},a.renderDisplayQR=function(){var t=this;return m("div",null,m("p",null,e().translator.trans("ianm-twofactor.forum.security.scan_new_device_qr")),m("div",{className:"tabs"},m(h(),{className:"TwoFactorModal-tab "+("qrcode"===this.activeTab?"active":""),onclick:function(){t.activeTab="qrcode",m.redraw()}},e().translator.trans("ianm-twofactor.forum.security.qr_tab")),m(h(),{className:"TwoFactorModal-tab "+("manual"===this.activeTab?"active":""),onclick:function(){t.activeTab="manual",m.redraw()}},e().translator.trans("ianm-twofactor.forum.security.manual_tab"))),"qrcode"===this.activeTab&&m("div",{className:"qrSection"},m("img",{className:"qrImage",src:this.qrCodeUrl,alt:e().translator.trans("ianm-twofactor.forum.security.qr_code_alt")})),"manual"===this.activeTab&&m("div",{className:"manualEntrySection"},m("code",{className:"manualEntryCode"},this.code),m("p",{className:"helpText"},e().translator.trans("ianm-twofactor.forum.security.manual_entry_instruction"))),m("p",null,e().translator.trans("ianm-twofactor.forum.security.verify_new_device_message")),m("div",{className:"Form"},m("form",{onsubmit:this.onVerifyNewDeviceSubmit.bind(this)},m("div",{className:"Form-group"},m(E,{placeholder:e().translator.trans("ianm-twofactor.forum.security.enter_new_token"),initial:this.newToken(),onComplete:function(o){t.newToken(o),t.verifyNewDevice()}})),m("div",{className:"Form-group"},m(h(),{type:"submit",className:"Button Button--primary",loading:this.loading},e().translator.trans("ianm-twofactor.forum.security.verify_button"))))))},a.renderBackupCodes=function(){var t=this;return m("div",null,m("p",null,e().translator.trans("ianm-twofactor.forum.security.new_backup_codes")),m("ul",null,this.backupCodes.map((function(t){return m("li",null,m("code",null,t))}))),m("p",null,e().translator.trans("ianm-twofactor.forum.security.backup_codes_instruction")),m(h(),{className:"Button Button--primary",onclick:function(){t.status="final",m.redraw()}},e().translator.trans("ianm-twofactor.forum.security.saved_backup_codes_button")))},a.renderFinal=function(){return m("div",null,m("p",null,e().translator.trans("ianm-twofactor.forum.security.device_changed_confirmation")),m(h(),{className:"Button Button--primary",onclick:this.finish.bind(this)},e().translator.trans("ianm-twofactor.forum.security.continue_button")))},a.onVerifyCurrentDeviceSubmit=function(t){t.preventDefault(),this.verifyCurrentDevice()},a.verifyCurrentDevice=function(){var t=this;this.loading=!0,e().request({method:"POST",url:e().forum.attribute("apiUrl")+"/users/twofactor/verify-current",body:{token:this.currentToken()}}).then((function(){t.status="loadingQR",m.redraw(),t.loadQrCode()})).catch((function(o){t.loading=!1,m.redraw()}))},a.loadQrCode=function(){var t=this,o=this.user.id();e().request({method:"GET",url:e().forum.attribute("apiUrl")+"/users/"+o+"/twofactor/change-device/qrcode"}).then((function(o){t.qrCodeUrl=o.svg,t.code=o.code,t.status="displayQR",t.loading=!1,m.redraw()})).catch((function(){t.loading=!1,m.redraw()}))},a.onVerifyNewDeviceSubmit=function(t){t.preventDefault(),this.verifyNewDevice()},a.verifyNewDevice=function(){var t=this;this.loading=!0,e().request({method:"POST",url:e().forum.attribute("apiUrl")+"/users/twofactor/change-device/verify",body:{token:this.newToken()}}).then((function(o){var a=o.backupCodes;t.backupCodes=a,t.status="displayBackupCodes",t.loading=!1,m.redraw()})).catch((function(){t.loading=!1,m.redraw()}))},a.finish=function(){var t,o;null==(t=(o=this.attrs).onDeviceChanged)||t.call(o),this.hide()},o}(N()),U=function(t){function o(){for(var o,a=arguments.length,r=new Array(a),e=0;e<a;e++)r[e]=arguments[e];return(o=t.call.apply(t,[this].concat(r))||this).user=void 0,o.twoFactorEnabled=void 0,o.canDisableTwoFactor=void 0,o.backupCodesRemaining=void 0,o}u(o,t);var a=o.prototype;return a.oninit=function(o){t.prototype.oninit.call(this,o),this.user=this.attrs.user,this.twoFactorEnabled=this.user.twoFactorEnabled(),this.canDisableTwoFactor=this.user.canDisable2FA(),this.backupCodesRemaining=this.user.backupCodesRemaining()||0},a.view=function(){return m("div",{className:"TwoFactorGrid"},m("ul",null,y()(this.twoFactorItems().toArray())))},a.twoFactorItems=function(){var t=new(v()),o=this.getDisableAction(),a=m(h(),{className:"Button Button--primary",onclick:this.enableTwoFactor.bind(this)},e().translator.trans("ianm-twofactor.forum.security.enable_2fa_button"));return t.add("status",m(g,{icon:"fas fa-shield-alt",title:e().translator.trans("ianm-twofactor.forum.security.two_factor_title"),value:this.twoFactorEnabled?e().translator.trans("ianm-twofactor.forum.security.two_factor_enabled"):e().translator.trans("ianm-twofactor.forum.security.two_factor_disabled"),action:this.twoFactorEnabled?o:a,helpText:!this.canDisableTwoFactor&&e().translator.trans("ianm-twofactor.forum.security.cannot_disable")})),this.twoFactorEnabled?(t.add("changeDevice",m(g,{icon:"fas fa-mobile-alt",title:e().translator.trans("ianm-twofactor.forum.security.change_device_title"),value:e().translator.trans("ianm-twofactor.forum.security.change_device_description"),action:m(h(),{className:"Button",onclick:this.changeDevice.bind(this)},e().translator.trans("ianm-twofactor.forum.security.change_device_button"))})),t.add("backupCodes",m(g,{icon:"fas fa-key",title:e().translator.trans("ianm-twofactor.forum.security.backup_codes_remaining"),value:this.backupCodesRemaining})),t):t},a.getDisableAction=function(){var t=m(h(),{className:"Button Button--danger",onclick:this.disableTwoFactor.bind(this),disabled:!this.canDisableTwoFactor},e().translator.trans("ianm-twofactor.forum.security.disable_2fa_button"));return this.canDisableTwoFactor?t:m(T(),{text:e().translator.trans("ianm-twofactor.forum.security.cannot_disable_tooltip")},t)},a.enableTwoFactor=function(){e().modal.show(x,{onEnabled:this.onTwoFactorEnabled.bind(this),user:this.user})},a.onTwoFactorEnabled=function(){this.twoFactorEnabled=!0,m.redraw()},a.disableTwoFactor=function(){e().modal.show(R,{onDisabled:this.onTwoFactorDisabled.bind(this),user:this.user})},a.onTwoFactorDisabled=function(){this.twoFactorEnabled=!1,m.redraw()},a.changeDevice=function(){e().modal.show(A,{user:this.user,onDeviceChanged:this.onDeviceChanged.bind(this)})},a.onDeviceChanged=function(){this.backupCodesRemaining=this.user.backupCodesRemaining()||0,m.redraw()},a.generateBackupCodes=function(){m.redraw()},o}(d()),O=function(t){function o(){return t.apply(this,arguments)||this}u(o,t);var a=o.prototype;return a.oninit=function(o){t.prototype.oninit.call(this,o)},a.view=function(){return m("div",null,m(U,{user:this.attrs.user}))},o}(d());const Q=flarum.core.compat["common/components/FieldSet"];var G=t.n(Q);const P=flarum.core.compat["common/components/LinkButton"];var V=t.n(P);const I=flarum.core.compat["forum/components/LogInModal"];var j=t.n(I);const L=flarum.core.compat["common/extenders"];var z=t.n(L);const K=flarum.core.compat["common/models/Group"];var H=t.n(K);const J=flarum.core.compat["common/models/User"];var W=t.n(J);const X=[new(z().Model)(W()).attribute("twoFactorEnabled").attribute("canDisable2FA").attribute("mustEnable2FA").attribute("backupCodesRemaining"),new(z().Model)(H()).attribute("requires2FA")],Y=[].concat(X);e().initializers.add("ianm/twofactor",(function(){(0,n.extend)(s().prototype,"settingsItems",(function(t){t.add("twoFactor",m(G(),{label:e().translator.trans("ianm-twofactor.forum.security.two_factor_heading")},m("p",{className:"helpText"},e().translator.trans("ianm-twofactor.forum.security.two_factor_help")),m("p",{className:"helpText"},e().translator.trans("ianm-twofactor.forum.security.two_factor_apps",{google:m(V(),{external:!0,href:"https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2",target:"_blank",rel:"noopener noreferrer"},"Google Authenticator"),microsoft:m(V(),{external:!0,href:"https://www.microsoft.com/en-us/account/authenticator",target:"_blank",rel:"noopener noreferrer"},"Microsoft Authenticator"),authy:m(V(),{external:!0,href:"https://authy.com/download/",target:"_blank",rel:"noopener noreferrer"},"Authy")})),m(O,{user:this.user})),100)})),(0,n.extend)(j().prototype,"oninit",(function(t){this.twoFactorToken=D()(""),this.twoFactorRequired=!1})),(0,n.extend)(j().prototype,"fields",(function(t){var o=this;this.twoFactorRequired&&(t.add("twoFactor",m("div",{className:"Form-group TwoFactorInput"},m("legend",null,e().translator.trans("ianm-twofactor.forum.log_in.two_factor_required_message")),m("input",{className:"FormControl",name:"twoFactorToken",type:"text",placeholder:e().translator.trans("ianm-twofactor.forum.log_in.two_factor_placeholder"),value:this.twoFactorToken(),disabled:this.loading,inputmode:"numeric",pattern:"[0-9]*",autocomplete:"one-time-code",oninput:function(t){o.twoFactorToken(t.currentTarget.value),6===t.target.value.length&&o.onsubmit(new Event("submit"))}})),19),t.remove("identification"),t.remove("password"),t.remove("remember"))})),(0,n.extend)(j().prototype,"loginParams",(function(t){return t.twoFactorToken=this.twoFactorToken(),t})),(0,n.override)(j().prototype,"body",(function(t){return this.twoFactorRequired?m("div",{className:"Form Form--centered"},this.fields().toArray()):t()})),(0,n.override)(j().prototype,"footer",(function(t){return this.twoFactorRequired?m("div",null):t()})),(0,n.override)(j().prototype,"onerror",(function(t,o){if(422===o.status){var a=o.response&&o.response.errors;(a&&a[0]&&a[0].detail||"").includes("two_factor_required")?this.twoFactorRequired=!0:(o.alert.content=e().translator.trans("core.forum.log_in.invalid_login_message"),this.alertAttrs=o.alert),m.redraw(),this.onready()}else t(o)})),new Promise((function(){setTimeout((function(){var t;null!=(t=e().session.user)&&t.mustEnable2FA()&&e().modal.show(x,{user:e().session.user,forced:!0})}),300)}))}))})(),module.exports=o})();
//# sourceMappingURL=forum.js.map